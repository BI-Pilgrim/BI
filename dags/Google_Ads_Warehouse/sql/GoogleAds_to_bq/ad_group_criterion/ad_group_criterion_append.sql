MERGE INTO `shopify-pubsub-project.Data_Warehouse_GoogleAds_Staging.ad_group_criterion` AS TARGET
USING
(
SELECT
_airbyte_extracted_at,
ad_group_criterion_ad_group,
ad_group_criterion_age_range_type,
ad_group_criterion_app_payment_model_type,
ad_group_criterion_approval_status,
ad_group_criterion_audience_audience,
ad_group_criterion_bid_modifier,
ad_group_criterion_cpc_bid_micros,
ad_group_criterion_cpm_bid_micros,
ad_group_criterion_cpv_bid_micros,
ad_group_criterion_criterion_id,
ad_group_criterion_custom_audience_custom_audience,
ad_group_criterion_custom_intent_custom_intent,
ad_group_criterion_display_name,
ad_group_criterion_effective_cpc_bid_micros,
ad_group_criterion_effective_cpc_bid_source,
ad_group_criterion_effective_cpm_bid_micros,
ad_group_criterion_effective_cpm_bid_source,
ad_group_criterion_effective_cpv_bid_micros,
ad_group_criterion_effective_cpv_bid_source,
ad_group_criterion_gender_type,
ad_group_criterion_income_range_type,
ad_group_criterion_keyword_match_type,
ad_group_criterion_keyword_text,
ad_group_criterion_mobile_app_category_mobile_app_category_constant,
ad_group_criterion_negative,
ad_group_criterion_parental_status_type,
ad_group_criterion_position_estimates_estimated_add_clicks_at_first_position_cpc,
ad_group_criterion_position_estimates_estimated_add_cost_at_first_position_cpc,
ad_group_criterion_position_estimates_first_page_cpc_micros,
ad_group_criterion_position_estimates_first_position_cpc_micros,
ad_group_criterion_position_estimates_top_of_page_cpc_micros,
ad_group_criterion_quality_info_creative_quality_score,
ad_group_criterion_quality_info_post_click_quality_score,
ad_group_criterion_quality_info_quality_score,
ad_group_criterion_quality_info_search_predicted_ctr,
ad_group_criterion_resource_name,
ad_group_criterion_status,
ad_group_criterion_system_serving_status,
ad_group_criterion_topic_topic_constant,
ad_group_criterion_type,
ad_group_criterion_user_interest_user_interest_category,
ad_group_criterion_user_list_user_list,
ad_group_criterion_webpage_criterion_name,
ad_group_criterion_youtube_channel_channel_id,
ad_group_id,
change_status_last_change_date_time,
deleted_at,
JSON_EXTRACT_SCALAR(ad_group_criterion_disapproval_reasons, '$[0]') AS criterion_disapproval_reasons,
JSON_EXTRACT_SCALAR(ad_group_criterion_final_urls, '$[0]') AS criterion_final_urls,
JSON_EXTRACT_SCALAR(ad_group_criterion_labels, '$[0]') AS criterion_labels,
FROM
(
select *,
row_number() over(partition by ad_group_criterion_resource_name order by _airbyte_extracted_at desc) as rn
from shopify-pubsub-project.pilgrim_bi_google_ads.ad_group_criterion
)
where rn = 1 and DATE(_airbyte_extracted_at) >= DATE_SUB(CURRENT_DATE("Asia/Kolkata"), INTERVAL 10 DAY)
) AS SOURCE
ON TARGET.ad_group_criterion_resource_name = SOURCE.ad_group_criterion_resource_name
WHEN
  MATCHED AND SOURCE._airbyte_extracted_at > TARGET._airbyte_extracted_at
THEN
  UPDATE SET
TARGET._airbyte_extracted_at = SOURCE._airbyte_extracted_at,
TARGET.ad_group_criterion_ad_group = SOURCE.ad_group_criterion_ad_group,
TARGET.ad_group_criterion_age_range_type = SOURCE.ad_group_criterion_age_range_type,
TARGET.ad_group_criterion_app_payment_model_type = SOURCE.ad_group_criterion_app_payment_model_type,
TARGET.ad_group_criterion_approval_status = SOURCE.ad_group_criterion_approval_status,
TARGET.ad_group_criterion_audience_audience = SOURCE.ad_group_criterion_audience_audience,
TARGET.ad_group_criterion_bid_modifier = SOURCE.ad_group_criterion_bid_modifier,
TARGET.ad_group_criterion_cpc_bid_micros = SOURCE.ad_group_criterion_cpc_bid_micros,
TARGET.ad_group_criterion_cpm_bid_micros = SOURCE.ad_group_criterion_cpm_bid_micros,
TARGET.ad_group_criterion_cpv_bid_micros = SOURCE.ad_group_criterion_cpv_bid_micros,
TARGET.ad_group_criterion_criterion_id = SOURCE.ad_group_criterion_criterion_id,
TARGET.ad_group_criterion_custom_audience_custom_audience = SOURCE.ad_group_criterion_custom_audience_custom_audience,
TARGET.ad_group_criterion_custom_intent_custom_intent = SOURCE.ad_group_criterion_custom_intent_custom_intent,
TARGET.ad_group_criterion_display_name = SOURCE.ad_group_criterion_display_name,
TARGET.ad_group_criterion_effective_cpc_bid_micros = SOURCE.ad_group_criterion_effective_cpc_bid_micros,
TARGET.ad_group_criterion_effective_cpc_bid_source = SOURCE.ad_group_criterion_effective_cpc_bid_source,
TARGET.ad_group_criterion_effective_cpm_bid_micros = SOURCE.ad_group_criterion_effective_cpm_bid_micros,
TARGET.ad_group_criterion_effective_cpm_bid_source = SOURCE.ad_group_criterion_effective_cpm_bid_source,
TARGET.ad_group_criterion_effective_cpv_bid_micros = SOURCE.ad_group_criterion_effective_cpv_bid_micros,
TARGET.ad_group_criterion_effective_cpv_bid_source = SOURCE.ad_group_criterion_effective_cpv_bid_source,
TARGET.ad_group_criterion_gender_type = SOURCE.ad_group_criterion_gender_type,
TARGET.ad_group_criterion_income_range_type = SOURCE.ad_group_criterion_income_range_type,
TARGET.ad_group_criterion_keyword_match_type = SOURCE.ad_group_criterion_keyword_match_type,
TARGET.ad_group_criterion_keyword_text = SOURCE.ad_group_criterion_keyword_text,
TARGET.ad_group_criterion_mobile_app_category_mobile_app_category_constant = SOURCE.ad_group_criterion_mobile_app_category_mobile_app_category_constant,
TARGET.ad_group_criterion_negative = SOURCE.ad_group_criterion_negative,
TARGET.ad_group_criterion_parental_status_type = SOURCE.ad_group_criterion_parental_status_type,
TARGET.ad_group_criterion_position_estimates_estimated_add_clicks_at_first_position_cpc = SOURCE.ad_group_criterion_position_estimates_estimated_add_clicks_at_first_position_cpc,
TARGET.ad_group_criterion_position_estimates_estimated_add_cost_at_first_position_cpc = SOURCE.ad_group_criterion_position_estimates_estimated_add_cost_at_first_position_cpc,
TARGET.ad_group_criterion_position_estimates_first_page_cpc_micros = SOURCE.ad_group_criterion_position_estimates_first_page_cpc_micros,
TARGET.ad_group_criterion_position_estimates_first_position_cpc_micros = SOURCE.ad_group_criterion_position_estimates_first_position_cpc_micros,
TARGET.ad_group_criterion_position_estimates_top_of_page_cpc_micros = SOURCE.ad_group_criterion_position_estimates_top_of_page_cpc_micros,
TARGET.ad_group_criterion_quality_info_creative_quality_score = SOURCE.ad_group_criterion_quality_info_creative_quality_score,
TARGET.ad_group_criterion_quality_info_post_click_quality_score = SOURCE.ad_group_criterion_quality_info_post_click_quality_score,
TARGET.ad_group_criterion_quality_info_quality_score = SOURCE.ad_group_criterion_quality_info_quality_score,
TARGET.ad_group_criterion_quality_info_search_predicted_ctr = SOURCE.ad_group_criterion_quality_info_search_predicted_ctr,
TARGET.ad_group_criterion_resource_name = SOURCE.ad_group_criterion_resource_name,
TARGET.ad_group_criterion_status = SOURCE.ad_group_criterion_status,
TARGET.ad_group_criterion_system_serving_status = SOURCE.ad_group_criterion_system_serving_status,
TARGET.ad_group_criterion_topic_topic_constant = SOURCE.ad_group_criterion_topic_topic_constant,
TARGET.ad_group_criterion_type = SOURCE.ad_group_criterion_type,
TARGET.ad_group_criterion_user_interest_user_interest_category = SOURCE.ad_group_criterion_user_interest_user_interest_category,
TARGET.ad_group_criterion_user_list_user_list = SOURCE.ad_group_criterion_user_list_user_list,
TARGET.ad_group_criterion_webpage_criterion_name = SOURCE.ad_group_criterion_webpage_criterion_name,
TARGET.ad_group_criterion_youtube_channel_channel_id = SOURCE.ad_group_criterion_youtube_channel_channel_id,
TARGET.ad_group_id = SOURCE.ad_group_id,
TARGET.change_status_last_change_date_time = SOURCE.change_status_last_change_date_time,
TARGET.deleted_at = SOURCE.deleted_at,
TARGET.criterion_disapproval_reasons = SOURCE.criterion_disapproval_reasons,
TARGET.criterion_final_urls = SOURCE.criterion_final_urls,
TARGET.criterion_labels = SOURCE.criterion_labels
WHEN NOT MATCHED
THEN INSERT
(
  _airbyte_extracted_at,
  ad_group_criterion_ad_group,
  ad_group_criterion_age_range_type,
  ad_group_criterion_app_payment_model_type,
  ad_group_criterion_approval_status,
  ad_group_criterion_audience_audience,
  ad_group_criterion_bid_modifier,
  ad_group_criterion_cpc_bid_micros,
  ad_group_criterion_cpm_bid_micros,
  ad_group_criterion_cpv_bid_micros,
  ad_group_criterion_criterion_id,
  ad_group_criterion_custom_audience_custom_audience,
  ad_group_criterion_custom_intent_custom_intent,
  ad_group_criterion_display_name,
  ad_group_criterion_effective_cpc_bid_micros,
  ad_group_criterion_effective_cpc_bid_source,
  ad_group_criterion_effective_cpm_bid_micros,
  ad_group_criterion_effective_cpm_bid_source,
  ad_group_criterion_effective_cpv_bid_micros,
  ad_group_criterion_effective_cpv_bid_source,
  ad_group_criterion_gender_type,
  ad_group_criterion_income_range_type,
  ad_group_criterion_keyword_match_type,
  ad_group_criterion_keyword_text,
  ad_group_criterion_mobile_app_category_mobile_app_category_constant,
  ad_group_criterion_negative,
  ad_group_criterion_parental_status_type,
  ad_group_criterion_position_estimates_estimated_add_clicks_at_first_position_cpc,
  ad_group_criterion_position_estimates_estimated_add_cost_at_first_position_cpc,
  ad_group_criterion_position_estimates_first_page_cpc_micros,
  ad_group_criterion_position_estimates_first_position_cpc_micros,
  ad_group_criterion_position_estimates_top_of_page_cpc_micros,
  ad_group_criterion_quality_info_creative_quality_score,
  ad_group_criterion_quality_info_post_click_quality_score,
  ad_group_criterion_quality_info_quality_score,
  ad_group_criterion_quality_info_search_predicted_ctr,
  ad_group_criterion_resource_name,
  ad_group_criterion_status,
  ad_group_criterion_system_serving_status,
  ad_group_criterion_topic_topic_constant,
  ad_group_criterion_type,
  ad_group_criterion_user_interest_user_interest_category,
  ad_group_criterion_user_list_user_list,
  ad_group_criterion_webpage_criterion_name,
  ad_group_criterion_youtube_channel_channel_id,
  ad_group_id,
  change_status_last_change_date_time,
  deleted_at,
  criterion_disapproval_reasons,
  criterion_final_urls,
  criterion_labels
)
VALUES
(
SOURCE._airbyte_extracted_at,
SOURCE.ad_group_criterion_ad_group,
SOURCE.ad_group_criterion_age_range_type,
SOURCE.ad_group_criterion_app_payment_model_type,
SOURCE.ad_group_criterion_approval_status,
SOURCE.ad_group_criterion_audience_audience,
SOURCE.ad_group_criterion_bid_modifier,
SOURCE.ad_group_criterion_cpc_bid_micros,
SOURCE.ad_group_criterion_cpm_bid_micros,
SOURCE.ad_group_criterion_cpv_bid_micros,
SOURCE.ad_group_criterion_criterion_id,
SOURCE.ad_group_criterion_custom_audience_custom_audience,
SOURCE.ad_group_criterion_custom_intent_custom_intent,
SOURCE.ad_group_criterion_display_name,
SOURCE.ad_group_criterion_effective_cpc_bid_micros,
SOURCE.ad_group_criterion_effective_cpc_bid_source,
SOURCE.ad_group_criterion_effective_cpm_bid_micros,
SOURCE.ad_group_criterion_effective_cpm_bid_source,
SOURCE.ad_group_criterion_effective_cpv_bid_micros,
SOURCE.ad_group_criterion_effective_cpv_bid_source,
SOURCE.ad_group_criterion_gender_type,
SOURCE.ad_group_criterion_income_range_type,
SOURCE.ad_group_criterion_keyword_match_type,
SOURCE.ad_group_criterion_keyword_text,
SOURCE.ad_group_criterion_mobile_app_category_mobile_app_category_constant,
SOURCE.ad_group_criterion_negative,
SOURCE.ad_group_criterion_parental_status_type,
SOURCE.ad_group_criterion_position_estimates_estimated_add_clicks_at_first_position_cpc,
SOURCE.ad_group_criterion_position_estimates_estimated_add_cost_at_first_position_cpc,
SOURCE.ad_group_criterion_position_estimates_first_page_cpc_micros,
SOURCE.ad_group_criterion_position_estimates_first_position_cpc_micros,
SOURCE.ad_group_criterion_position_estimates_top_of_page_cpc_micros,
SOURCE.ad_group_criterion_quality_info_creative_quality_score,
SOURCE.ad_group_criterion_quality_info_post_click_quality_score,
SOURCE.ad_group_criterion_quality_info_quality_score,
SOURCE.ad_group_criterion_quality_info_search_predicted_ctr,
SOURCE.ad_group_criterion_resource_name,
SOURCE.ad_group_criterion_status,
SOURCE.ad_group_criterion_system_serving_status,
SOURCE.ad_group_criterion_topic_topic_constant,
SOURCE.ad_group_criterion_type,
SOURCE.ad_group_criterion_user_interest_user_interest_category,
SOURCE.ad_group_criterion_user_list_user_list,
SOURCE.ad_group_criterion_webpage_criterion_name,
SOURCE.ad_group_criterion_youtube_channel_channel_id,
SOURCE.ad_group_id,
SOURCE.change_status_last_change_date_time,
SOURCE.deleted_at,
SOURCE.criterion_disapproval_reasons,
SOURCE.criterion_final_urls,
SOURCE.criterion_labels
)
