MERGE INTO `shopify-pubsub-project.Data_Warehouse_GoogleAds_Staging.account_performance_report` AS TARGET
USING
(
select 
_airbyte_raw_id,
_airbyte_extracted_at,
_airbyte_meta,
_airbyte_generation_id,
rn,
customer_id,
segments_date,
metrics_ctr,
segments_ad_network_type,
segments_week,
segments_year,
metrics_clicks,
segments_month,
segments_device,
customer_manager,
segments_quarter,
customer_time_zone,
metrics_average_cpc,
metrics_average_cpe,
metrics_average_cpm,
metrics_average_cpv,
metrics_conversions,
metrics_cost_micros,
metrics_engagements,
metrics_impressions,
metrics_video_views,
metrics_average_cost,
metrics_interactions,
segments_day_of_week,
customer_test_account,
customer_currency_code,
metrics_active_view_cpm,
metrics_active_view_ctr,
metrics_all_conversions,
metrics_engagement_rate,
metrics_video_view_rate,
metrics_interaction_rate,
customer_descriptive_name,
metrics_conversions_value,
metrics_cost_per_conversion,
metrics_value_per_conversion,
customer_auto_tagging_enabled,
metrics_all_conversions_value,
metrics_active_view_impressions,
metrics_active_view_viewability,
metrics_interaction_event_types,
metrics_search_impression_share,
metrics_content_impression_share,
metrics_cost_per_all_conversions,
metrics_cross_device_conversions,
metrics_view_through_conversions,
metrics_active_view_measurability,
metrics_value_per_all_conversions,
metrics_search_rank_lost_impression_share,
metrics_active_view_measurable_cost_micros,
metrics_active_view_measurable_impressions,
metrics_content_rank_lost_impression_share,
metrics_conversions_from_interactions_rate,
metrics_search_budget_lost_impression_share,
metrics_search_exact_match_impression_share,
metrics_content_budget_lost_impression_share,
metrics_all_conversions_from_interactions_rate,
from
(
select
*,
row_number() over(partition by customer_id,segments_date,segments_device,segments_ad_network_type order by _airbyte_extracted_at) as rn
from shopify-pubsub-project.pilgrim_bi_google_ads.account_performance_report
)
where rn = 1 and DATE(_airbyte_extracted_at) >= DATE_SUB(CURRENT_DATE("Asia/Kolkata"), INTERVAL 10 DAY)-- Keep only the most recent row per customer_id and segments_date
) AS SOURCE
ON
  TARGET.customer_id = SOURCE.customer_id
  AND TARGET.segments_date = SOURCE.segments_date
WHEN MATCHED AND SOURCE._airbyte_extracted_at > TARGET._airbyte_extracted_at
THEN UPDATE SET
TARGET._airbyte_extracted_at = SOURCE._airbyte_extracted_at,
TARGET.customer_auto_tagging_enabled = SOURCE.customer_auto_tagging_enabled,
TARGET.customer_id = SOURCE.customer_id,
TARGET.customer_manager = SOURCE.customer_manager,
TARGET.customer_test_account = SOURCE.customer_test_account,
TARGET.metrics_active_view_cpm = SOURCE.metrics_active_view_cpm,
TARGET.metrics_active_view_ctr = SOURCE.metrics_active_view_ctr,
TARGET.metrics_active_view_impressions = SOURCE.metrics_active_view_impressions,
TARGET.metrics_active_view_measurability = SOURCE.metrics_active_view_measurability,
TARGET.metrics_active_view_measurable_cost_micros = SOURCE.metrics_active_view_measurable_cost_micros,
TARGET.metrics_active_view_measurable_impressions = SOURCE.metrics_active_view_measurable_impressions,
TARGET.metrics_active_view_viewability = SOURCE.metrics_active_view_viewability,
TARGET.metrics_all_conversions = SOURCE.metrics_all_conversions,
TARGET.metrics_all_conversions_from_interactions_rate = SOURCE.metrics_all_conversions_from_interactions_rate,
TARGET.metrics_all_conversions_value = SOURCE.metrics_all_conversions_value,
TARGET.metrics_average_cost = SOURCE.metrics_average_cost,
TARGET.metrics_average_cpc = SOURCE.metrics_average_cpc,
TARGET.metrics_average_cpe = SOURCE.metrics_average_cpe,
TARGET.metrics_average_cpm = SOURCE.metrics_average_cpm,
TARGET.metrics_average_cpv = SOURCE.metrics_average_cpv,
TARGET.metrics_clicks = SOURCE.metrics_clicks,
TARGET.metrics_content_budget_lost_impression_share = SOURCE.metrics_content_budget_lost_impression_share,
TARGET.metrics_content_impression_share = SOURCE.metrics_content_impression_share,
TARGET.metrics_content_rank_lost_impression_share = SOURCE.metrics_content_rank_lost_impression_share,
TARGET.metrics_conversions = SOURCE.metrics_conversions,
TARGET.metrics_conversions_from_interactions_rate = SOURCE.metrics_conversions_from_interactions_rate,
TARGET.metrics_conversions_value = SOURCE.metrics_conversions_value,
TARGET.metrics_cost_micros = SOURCE.metrics_cost_micros,
TARGET.metrics_cost_per_all_conversions = SOURCE.metrics_cost_per_all_conversions,
TARGET.metrics_cost_per_conversion = SOURCE.metrics_cost_per_conversion,
TARGET.metrics_cross_device_conversions = SOURCE.metrics_cross_device_conversions,
TARGET.metrics_ctr = SOURCE.metrics_ctr,
TARGET.metrics_engagement_rate = SOURCE.metrics_engagement_rate,
TARGET.metrics_engagements = SOURCE.metrics_engagements,
TARGET.metrics_impressions = SOURCE.metrics_impressions,
TARGET.metrics_interaction_rate = SOURCE.metrics_interaction_rate,
TARGET.metrics_interactions = SOURCE.metrics_interactions,
TARGET.metrics_search_budget_lost_impression_share = SOURCE.metrics_search_budget_lost_impression_share,
TARGET.metrics_search_exact_match_impression_share = SOURCE.metrics_search_exact_match_impression_share,
TARGET.metrics_search_impression_share = SOURCE.metrics_search_impression_share,
TARGET.metrics_search_rank_lost_impression_share = SOURCE.metrics_search_rank_lost_impression_share,
TARGET.metrics_value_per_all_conversions = SOURCE.metrics_value_per_all_conversions,
TARGET.metrics_value_per_conversion = SOURCE.metrics_value_per_conversion,
TARGET.metrics_video_view_rate = SOURCE.metrics_video_view_rate,
TARGET.metrics_video_views = SOURCE.metrics_video_views,
TARGET.metrics_view_through_conversions = SOURCE.metrics_view_through_conversions,
TARGET.segments_ad_network_type = SOURCE.segments_ad_network_type,
TARGET.segments_date = SOURCE.segments_date,
TARGET.segments_day_of_week = SOURCE.segments_day_of_week,
TARGET.segments_device = SOURCE.segments_device,
TARGET.segments_month = SOURCE.segments_month,
TARGET.segments_quarter = SOURCE.segments_quarter,
TARGET.segments_week = SOURCE.segments_week,
TARGET.segments_year = SOURCE.segments_year
WHEN NOT MATCHED
THEN INSERT
(
_airbyte_extracted_at,
customer_auto_tagging_enabled,
customer_id,
customer_manager,
customer_test_account,
metrics_active_view_cpm,
metrics_active_view_ctr,
metrics_active_view_impressions,
metrics_active_view_measurability,
metrics_active_view_measurable_cost_micros,
metrics_active_view_measurable_impressions,
metrics_active_view_viewability,
metrics_all_conversions,
metrics_all_conversions_from_interactions_rate,
metrics_all_conversions_value,
metrics_average_cost,
metrics_average_cpc,
metrics_average_cpe,
metrics_average_cpm,
metrics_average_cpv,
metrics_clicks,
metrics_content_budget_lost_impression_share,
metrics_content_impression_share,
metrics_content_rank_lost_impression_share,
metrics_conversions,
metrics_conversions_from_interactions_rate,
metrics_conversions_value,
metrics_cost_micros,
metrics_cost_per_all_conversions,
metrics_cost_per_conversion,
metrics_cross_device_conversions,
metrics_ctr,
metrics_engagement_rate,
metrics_engagements,
metrics_impressions,
metrics_interaction_rate,
metrics_interactions,
metrics_search_budget_lost_impression_share,
metrics_search_exact_match_impression_share,
metrics_search_impression_share,
metrics_search_rank_lost_impression_share,
metrics_value_per_all_conversions,
metrics_value_per_conversion,
metrics_video_view_rate,
metrics_video_views,
metrics_view_through_conversions,
segments_ad_network_type,
segments_date,
segments_day_of_week,
segments_device,
segments_month,
segments_quarter,
segments_week,
segments_year
)
VALUES
(
SOURCE._airbyte_extracted_at,
SOURCE.customer_auto_tagging_enabled,
SOURCE.customer_id,
SOURCE.customer_manager,
SOURCE.customer_test_account,
SOURCE.metrics_active_view_cpm,
SOURCE.metrics_active_view_ctr,
SOURCE.metrics_active_view_impressions,
SOURCE.metrics_active_view_measurability,
SOURCE.metrics_active_view_measurable_cost_micros,
SOURCE.metrics_active_view_measurable_impressions,
SOURCE.metrics_active_view_viewability,
SOURCE.metrics_all_conversions,
SOURCE.metrics_all_conversions_from_interactions_rate,
SOURCE.metrics_all_conversions_value,
SOURCE.metrics_average_cost,
SOURCE.metrics_average_cpc,
SOURCE.metrics_average_cpe,
SOURCE.metrics_average_cpm,
SOURCE.metrics_average_cpv,
SOURCE.metrics_clicks,
SOURCE.metrics_content_budget_lost_impression_share,
SOURCE.metrics_content_impression_share,
SOURCE.metrics_content_rank_lost_impression_share,
SOURCE.metrics_conversions,
SOURCE.metrics_conversions_from_interactions_rate,
SOURCE.metrics_conversions_value,
SOURCE.metrics_cost_micros,
SOURCE.metrics_cost_per_all_conversions,
SOURCE.metrics_cost_per_conversion,
SOURCE.metrics_cross_device_conversions,
SOURCE.metrics_ctr,
SOURCE.metrics_engagement_rate,
SOURCE.metrics_engagements,
SOURCE.metrics_impressions,
SOURCE.metrics_interaction_rate,
SOURCE.metrics_interactions,
SOURCE.metrics_search_budget_lost_impression_share,
SOURCE.metrics_search_exact_match_impression_share,
SOURCE.metrics_search_impression_share,
SOURCE.metrics_search_rank_lost_impression_share,
SOURCE.metrics_value_per_all_conversions,
SOURCE.metrics_value_per_conversion,
SOURCE.metrics_video_view_rate,
SOURCE.metrics_video_views,
SOURCE.metrics_view_through_conversions,
SOURCE.segments_ad_network_type,
SOURCE.segments_date,
SOURCE.segments_day_of_week,
SOURCE.segments_device,
SOURCE.segments_month,
SOURCE.segments_quarter,
SOURCE.segments_week,
SOURCE.segments_year
);
