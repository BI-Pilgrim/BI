MERGE INTO `shopify-pubsub-project.Data_Warehouse_GoogleAds_Staging.ad_group_ad_normal` as TARGET
USING
(
SELECT
  ad_group_ad_ad_call_ad_disable_call_conversion,
  ad_group_ad_ad_legacy_responsive_display_ad_allow_flexible_color,
  ad_group_ad_ad_responsive_display_ad_allow_flexible_color,
  ad_group_ad_ad_responsive_display_ad_control_spec_enable_asset_enhancements,
  ad_group_ad_ad_responsive_display_ad_control_spec_enable_autogen_video,
  ad_group_ad_ad_id,
  ad_group_ad_ad_image_ad_pixel_height,
  ad_group_ad_ad_image_ad_pixel_width,
  ad_group_ad_ad_image_ad_preview_pixel_height,
  ad_group_ad_ad_image_ad_preview_pixel_width,
  ad_group_id,
  segments_date,
  ad_group_ad_ad_app_ad_mandatory_ad_text,
  ad_group_ad_ad_call_ad_conversion_reporting_state,
  ad_group_ad_ad_display_upload_ad_display_upload_product_type,
  ad_group_ad_ad_expanded_dynamic_search_ad_description,
  ad_group_ad_ad_expanded_dynamic_search_ad_description2,
  ad_group_ad_ad_group,
  ad_group_ad_ad_image_ad_image_url,
  ad_group_ad_ad_image_ad_name,
  ad_group_ad_ad_image_ad_preview_image_url,
  ad_group_ad_ad_legacy_responsive_display_ad_format_setting,
  ad_group_ad_ad_resource_name,
  ad_group_ad_ad_responsive_display_ad_format_setting,
  ad_group_ad_ad_responsive_search_ad_path1,
  ad_group_ad_ad_responsive_search_ad_path2,
  ad_group_ad_ad_strength,
  ad_group_ad_ad_system_managed_resource_source,
  ad_group_ad_ad_text_ad_description1,
  ad_group_ad_ad_text_ad_description2,
  ad_group_ad_ad_tracking_url_template,
  ad_group_ad_ad_type,
  ad_group_ad_ad_video_ad_in_stream_action_button_label,
  ad_group_ad_ad_video_ad_in_stream_action_headline,
  ad_group_ad_policy_summary_approval_status,
  ad_group_ad_policy_summary_review_status,
  ad_group_ad_resource_name,
  ad_group_ad_status,
  _airbyte_extracted_at,
FROM
(
select *,
row_number() over(partition by ad_group_ad_ad_id,segments_date order by _airbyte_extracted_at desc) rn
from `shopify-pubsub-project.pilgrim_bi_google_ads.ad_group_ad`
)
where rn = 1 and DATE(_airbyte_extracted_at) >= DATE_SUB(CURRENT_DATE("Asia/Kolkata"), INTERVAL 30 DAY)
) AS SOURCE
ON TARGET.ad_group_ad_ad_id = SOURCE.ad_group_ad_ad_id
and TARGET.segments_date = SOURCE.segments_date
WHEN MATCHED AND SOURCE._airbyte_extracted_at > TARGET._airbyte_extracted_at
THEN UPDATE SET
  TARGET.ad_group_ad_ad_call_ad_disable_call_conversion = SOURCE.ad_group_ad_ad_call_ad_disable_call_conversion,
  TARGET.ad_group_ad_ad_legacy_responsive_display_ad_allow_flexible_color = SOURCE.ad_group_ad_ad_legacy_responsive_display_ad_allow_flexible_color,
  TARGET.ad_group_ad_ad_responsive_display_ad_allow_flexible_color = SOURCE.ad_group_ad_ad_responsive_display_ad_allow_flexible_color,
  TARGET.ad_group_ad_ad_responsive_display_ad_control_spec_enable_asset_enhancements = SOURCE.ad_group_ad_ad_responsive_display_ad_control_spec_enable_asset_enhancements,
  TARGET.ad_group_ad_ad_responsive_display_ad_control_spec_enable_autogen_video = SOURCE.ad_group_ad_ad_responsive_display_ad_control_spec_enable_autogen_video,
  TARGET.ad_group_ad_ad_id = SOURCE.ad_group_ad_ad_id,
  TARGET.ad_group_ad_ad_image_ad_pixel_height = SOURCE.ad_group_ad_ad_image_ad_pixel_height,
  TARGET.ad_group_ad_ad_image_ad_pixel_width = SOURCE.ad_group_ad_ad_image_ad_pixel_width,
  TARGET.ad_group_ad_ad_image_ad_preview_pixel_height = SOURCE.ad_group_ad_ad_image_ad_preview_pixel_height,
  TARGET.ad_group_ad_ad_image_ad_preview_pixel_width = SOURCE.ad_group_ad_ad_image_ad_preview_pixel_width,
  TARGET.ad_group_id = SOURCE.ad_group_id,
  TARGET.segments_date = SOURCE.segments_date,
  TARGET.ad_group_ad_ad_app_ad_mandatory_ad_text = SOURCE.ad_group_ad_ad_app_ad_mandatory_ad_text,
  TARGET.ad_group_ad_ad_call_ad_conversion_reporting_state = SOURCE.ad_group_ad_ad_call_ad_conversion_reporting_state,
  TARGET.ad_group_ad_ad_display_upload_ad_display_upload_product_type = SOURCE.ad_group_ad_ad_display_upload_ad_display_upload_product_type,
  TARGET.ad_group_ad_ad_expanded_dynamic_search_ad_description = SOURCE.ad_group_ad_ad_expanded_dynamic_search_ad_description,
  TARGET.ad_group_ad_ad_expanded_dynamic_search_ad_description2 = SOURCE.ad_group_ad_ad_expanded_dynamic_search_ad_description2,
  TARGET.ad_group_ad_ad_group = SOURCE.ad_group_ad_ad_group,
  TARGET.ad_group_ad_ad_image_ad_image_url = SOURCE.ad_group_ad_ad_image_ad_image_url,
  TARGET.ad_group_ad_ad_image_ad_name = SOURCE.ad_group_ad_ad_image_ad_name,
  TARGET.ad_group_ad_ad_image_ad_preview_image_url = SOURCE.ad_group_ad_ad_image_ad_preview_image_url,
  TARGET.ad_group_ad_ad_legacy_responsive_display_ad_format_setting = SOURCE.ad_group_ad_ad_legacy_responsive_display_ad_format_setting,
  TARGET.ad_group_ad_ad_resource_name = SOURCE.ad_group_ad_ad_resource_name,
  TARGET.ad_group_ad_ad_responsive_display_ad_format_setting = SOURCE.ad_group_ad_ad_responsive_display_ad_format_setting,
  TARGET.ad_group_ad_ad_responsive_search_ad_path1 = SOURCE.ad_group_ad_ad_responsive_search_ad_path1,
  TARGET.ad_group_ad_ad_responsive_search_ad_path2 = SOURCE.ad_group_ad_ad_responsive_search_ad_path2,
  TARGET.ad_group_ad_ad_strength = SOURCE.ad_group_ad_ad_strength,
  TARGET.ad_group_ad_ad_system_managed_resource_source = SOURCE.ad_group_ad_ad_system_managed_resource_source,
  TARGET.ad_group_ad_ad_text_ad_description1 = SOURCE.ad_group_ad_ad_text_ad_description1,
  TARGET.ad_group_ad_ad_text_ad_description2 = SOURCE.ad_group_ad_ad_text_ad_description2,
  TARGET.ad_group_ad_ad_tracking_url_template = SOURCE.ad_group_ad_ad_tracking_url_template,
  TARGET.ad_group_ad_ad_type = SOURCE.ad_group_ad_ad_type,
  TARGET.ad_group_ad_ad_video_ad_in_stream_action_button_label = SOURCE.ad_group_ad_ad_video_ad_in_stream_action_button_label,
  TARGET.ad_group_ad_ad_video_ad_in_stream_action_headline = SOURCE.ad_group_ad_ad_video_ad_in_stream_action_headline,
  TARGET.ad_group_ad_policy_summary_approval_status = SOURCE.ad_group_ad_policy_summary_approval_status,
  TARGET.ad_group_ad_policy_summary_review_status = SOURCE.ad_group_ad_policy_summary_review_status,
  TARGET.ad_group_ad_resource_name = SOURCE.ad_group_ad_resource_name,
  TARGET.ad_group_ad_status = SOURCE.ad_group_ad_status,
  TARGET._airbyte_extracted_at = SOURCE._airbyte_extracted_at
WHEN NOT MATCHED
THEN INSERT
(
  ad_group_ad_ad_call_ad_disable_call_conversion,
  ad_group_ad_ad_legacy_responsive_display_ad_allow_flexible_color,
  ad_group_ad_ad_responsive_display_ad_allow_flexible_color,
  ad_group_ad_ad_responsive_display_ad_control_spec_enable_asset_enhancements,
  ad_group_ad_ad_responsive_display_ad_control_spec_enable_autogen_video,
  ad_group_ad_ad_id,
  ad_group_ad_ad_image_ad_pixel_height,
  ad_group_ad_ad_image_ad_pixel_width,
  ad_group_ad_ad_image_ad_preview_pixel_height,
  ad_group_ad_ad_image_ad_preview_pixel_width,
  ad_group_id,
  segments_date,
  ad_group_ad_ad_app_ad_mandatory_ad_text,
  ad_group_ad_ad_call_ad_conversion_reporting_state,
  ad_group_ad_ad_display_upload_ad_display_upload_product_type,
  ad_group_ad_ad_expanded_dynamic_search_ad_description,
  ad_group_ad_ad_expanded_dynamic_search_ad_description2,
  ad_group_ad_ad_group,
  ad_group_ad_ad_image_ad_image_url,
  ad_group_ad_ad_image_ad_name,
  ad_group_ad_ad_image_ad_preview_image_url,
  ad_group_ad_ad_legacy_responsive_display_ad_format_setting,
  ad_group_ad_ad_resource_name,
  ad_group_ad_ad_responsive_display_ad_format_setting,
  ad_group_ad_ad_responsive_search_ad_path1,
  ad_group_ad_ad_responsive_search_ad_path2,
  ad_group_ad_ad_strength,
  ad_group_ad_ad_system_managed_resource_source,
  ad_group_ad_ad_text_ad_description1,
  ad_group_ad_ad_text_ad_description2,
  ad_group_ad_ad_tracking_url_template,
  ad_group_ad_ad_type,
  ad_group_ad_ad_video_ad_in_stream_action_button_label,
  ad_group_ad_ad_video_ad_in_stream_action_headline,
  ad_group_ad_policy_summary_approval_status,
  ad_group_ad_policy_summary_review_status,
  ad_group_ad_resource_name,
  ad_group_ad_status,
  _airbyte_extracted_at
)
VALUES
(
  SOURCE.ad_group_ad_ad_call_ad_disable_call_conversion,
  SOURCE.ad_group_ad_ad_legacy_responsive_display_ad_allow_flexible_color,
  SOURCE.ad_group_ad_ad_responsive_display_ad_allow_flexible_color,
  SOURCE.ad_group_ad_ad_responsive_display_ad_control_spec_enable_asset_enhancements,
  SOURCE.ad_group_ad_ad_responsive_display_ad_control_spec_enable_autogen_video,
  SOURCE.ad_group_ad_ad_id,
  SOURCE.ad_group_ad_ad_image_ad_pixel_height,
  SOURCE.ad_group_ad_ad_image_ad_pixel_width,
  SOURCE.ad_group_ad_ad_image_ad_preview_pixel_height,
  SOURCE.ad_group_ad_ad_image_ad_preview_pixel_width,
  SOURCE.ad_group_id,
  SOURCE.segments_date,
  SOURCE.ad_group_ad_ad_app_ad_mandatory_ad_text,
  SOURCE.ad_group_ad_ad_call_ad_conversion_reporting_state,
  SOURCE.ad_group_ad_ad_display_upload_ad_display_upload_product_type,
  SOURCE.ad_group_ad_ad_expanded_dynamic_search_ad_description,
  SOURCE.ad_group_ad_ad_expanded_dynamic_search_ad_description2,
  SOURCE.ad_group_ad_ad_group,
  SOURCE.ad_group_ad_ad_image_ad_image_url,
  SOURCE.ad_group_ad_ad_image_ad_name,
  SOURCE.ad_group_ad_ad_image_ad_preview_image_url,
  SOURCE.ad_group_ad_ad_legacy_responsive_display_ad_format_setting,
  SOURCE.ad_group_ad_ad_resource_name,
  SOURCE.ad_group_ad_ad_responsive_display_ad_format_setting,
  SOURCE.ad_group_ad_ad_responsive_search_ad_path1,
  SOURCE.ad_group_ad_ad_responsive_search_ad_path2,
  SOURCE.ad_group_ad_ad_strength,
  SOURCE.ad_group_ad_ad_system_managed_resource_source,
  SOURCE.ad_group_ad_ad_text_ad_description1,
  SOURCE.ad_group_ad_ad_text_ad_description2,
  SOURCE.ad_group_ad_ad_tracking_url_template,
  SOURCE.ad_group_ad_ad_type,
  SOURCE.ad_group_ad_ad_video_ad_in_stream_action_button_label,
  SOURCE.ad_group_ad_ad_video_ad_in_stream_action_headline,
  SOURCE.ad_group_ad_policy_summary_approval_status,
  SOURCE.ad_group_ad_policy_summary_review_status,
  SOURCE.ad_group_ad_resource_name,
  SOURCE.ad_group_ad_status,
  SOURCE._airbyte_extracted_at
)