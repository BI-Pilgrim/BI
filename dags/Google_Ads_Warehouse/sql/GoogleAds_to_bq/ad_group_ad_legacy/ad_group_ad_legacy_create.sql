CREATE OR REPLACE TABLE `shopify-pubsub-project.Data_Warehouse_GoogleAds_Staging.ad_group_ad_legacy`
PARTITION BY DATE_TRUNC(_airbyte_extracted_at, DAY)
AS
SELECT
_airbyte_extracted_at,
ad_group_ad_ad_added_by_google_ads,
ad_group_ad_ad_legacy_responsive_display_ad_allow_flexible_color,
ad_group_ad_ad_responsive_display_ad_allow_flexible_color,
segments_date,
_airbyte_generation_id,
ad_group_ad_ad_id,
ad_group_ad_ad_image_ad_pixel_height,
ad_group_ad_ad_image_ad_pixel_width,
ad_group_id,
campaign_id,
customer_id,
metrics_active_view_impressions,
metrics_active_view_measurable_cost_micros,
metrics_active_view_measurable_impressions,
metrics_clicks,
metrics_cost_micros,
metrics_engagements,
metrics_gmail_forwards,
metrics_gmail_saves,
metrics_gmail_secondary_clicks,
metrics_impressions,
metrics_interactions,
metrics_video_views,
metrics_view_through_conversions,
segments_year,
metrics_active_view_cpm,
metrics_active_view_ctr,
metrics_active_view_measurability,
metrics_active_view_viewability,
metrics_all_conversions,
metrics_all_conversions_from_interactions_rate,
metrics_all_conversions_value,
metrics_average_cost,
metrics_average_cpc,
metrics_average_cpe,
metrics_average_cpm,
metrics_average_cpv,
metrics_average_page_views,
metrics_average_time_on_site,
metrics_bounce_rate,
metrics_conversions,
metrics_conversions_from_interactions_rate,
metrics_conversions_value,
metrics_cost_per_all_conversions,
metrics_cost_per_conversion,
metrics_cost_per_current_model_attributed_conversion,
metrics_cross_device_conversions,
metrics_ctr,
metrics_current_model_attributed_conversions,
metrics_current_model_attributed_conversions_value,
metrics_engagement_rate,
metrics_interaction_rate,
metrics_percent_new_visitors,
metrics_top_impression_percentage,
metrics_value_per_all_conversions,
metrics_value_per_conversion,
metrics_value_per_current_model_attributed_conversion,
metrics_video_quartile_p100_rate,
metrics_video_quartile_p25_rate,
metrics_video_quartile_p50_rate,
metrics_video_quartile_p75_rate,
metrics_video_view_rate,
ad_group_ad_ad_device_preference,
ad_group_ad_ad_legacy_responsive_display_ad_format_setting,
ad_group_ad_ad_system_managed_resource_source,
ad_group_ad_ad_final_urls,
segments_ad_network_type,
JSON_EXTRACT_SCALAR(ad_group_ad_ad_final_urls, '$[0]') AS ad_final_url,
REGEXP_EXTRACT(JSON_EXTRACT_SCALAR(ad_group_ad_ad_responsive_display_ad_marketing_images, '$[0]'),r'customersd+assetsd+') AS extracted_marketing_images,
REGEXP_EXTRACT(JSON_EXTRACT_SCALAR(ad_group_ad_ad_responsive_display_ad_marketing_images, '$[0]'),r'customersd+assetsd+') AS extracted_sq_logo_images,
FROM
(
select *,
row_number() over(partition by ad_group_ad_ad_id,segments_date,segments_ad_network_type order by _airbyte_extracted_at desc) as rn
from shopify-pubsub-project.pilgrim_bi_google_ads.ad_group_ad_legacy
)
where rn = 1